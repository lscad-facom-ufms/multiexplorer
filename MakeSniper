all: getsniper getbenchmarks reqsniper reqbenchmarks

getsniper:
ifeq (,$(shell ls | grep sniper-latest.tgz))
	wget http://snipersim.org/download/3a763c96bd6ca36a/packages/sniper-latest.tgz
endif
ifeq (,$(shell ls -d */ | grep sniper))
	tar zxvf sniper-latest.tgz
endif

reqsniper:
	apt install -y gcc-multilib
	apt install -y g++-multilib
	apt install -y zlib1g-dev
	apt install -y libbz2-dev
	apt install -y libboost-dev
	apt install -y libsqlite3-dev

makesniper:
	make -C sniper-7.4/Makefile

getbenchmarks:
ifeq (,$(shell ls | grep sniper-benchmarks.tbz))
	wget http://snipersim.org/packages/sniper-benchmarks.tbz
endif
ifeq (,$(shell ls `ls -dt */ | grep sniper | head -1` | grep benchmarks))
	tar xvf sniper-benchmarks.tbz
	mv benchmarks `ls -dt */ | grep sniper | head -1`
endif

reqbenchmarks:
	apt install -y gfortran
	apt install -y m4
	apt install -y xsltproc
	apt install -y pkg-config
	apt install -y gettext
	apt install -y libx11-dev
	apt install -y libxext-dev
	apt install -y libxt-dev
	apt install -y libxmu-dev
	apt install -y libxi-dev

#in case of trouble compiling the benchmarks: https://groups.google.com/g/snipersim/c/2yL2x6nNfVs/m/EmqQlVf6EwAJ
fixbenchmarks:
	sed -i 's/make -C cpu2006/#make -C cpu2006/' `ls -dt */ | grep sniper | head -1`/benchmarks/Makefile
	sed -i 's/make -C npb/#make -C npb/' `ls -dt */ | grep sniper | head -1`/benchmarks/Makefile
	sed -i 's/make -C local/#make -C local/' `ls -dt */ | grep sniper | head -1`/benchmarks/Makefile
	sed -i 's/make -C cpu2006 clean/#make -C cpu2006 clean/' `ls -dt */ | grep sniper | head -1`/benchmarks/Makefile
	sed -i 's/make -C npb clean/#make -C npb clean/' `ls -dt */ | grep sniper | head -1`/benchmarks/Makefile
	sed -i 's/make -C local clean/#make -C local clean/' `ls -dt */ | grep sniper | head -1`/benchmarks/Makefile
	sed -i 's/CXXFLAGS="${CXXFLAGS} ${HOOKS_CXXFLAGS}"/CXXFLAGS="-std=gnu++98 ${CXXFLAGS} ${HOOKS_CXXFLAGS}"/' `ls -dt */ | grep sniper | head -1`/benchmarks/parsec/parsec-2.1/config/gcc-sniper.bldconf
	sed -i 's/HUGE/HUGE_VAL/g' `ls -dt */ | grep sniper | head -1`/benchmarks/parsec/parsec-2.1/pkgs/apps/ferret/src/src/lsh/LSH_query.c
	sed -i 's/HUGE/HUGE_VAL/g' `ls -dt */ | grep sniper | head -1`/benchmarks/parsec/parsec-2.1/pkgs/apps/ferret/src/src/lsh/LSH_query_batch.c
	sed -i 's/HUGE/HUGE_VAL/g' `ls -dt */ | grep sniper | head -1`/benchmarks/parsec/parsec-2.1/pkgs/apps/ferret/src/benchmark/ferret-parallel.c
	sed -i 's/HUGE/HUGE_VAL/g' `ls -dt */ | grep sniper | head -1`/benchmarks/parsec/parsec-2.1/pkgs/apps/ferret/src/benchmark/ferret-serial.c
makebenchmarks:
	make -C sniper-7.4/benchmarks/makefile
